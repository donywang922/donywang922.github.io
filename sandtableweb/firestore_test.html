<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firestore 房间同步</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 50px;
        }

        input, button {
            margin: 10px;
            padding: 10px;
            font-size: 16px;
        }

        #chatBox {
            width: 80%;
            height: 200px;
        }
    </style>
</head>
<body>
<h1>Firestore 房间同步</h1>
<div id="setup">
    <input id="nameInput" type="text" placeholder="你的名字">
    <button onclick="createRoom()">创建房间</button>
    <input id="roomInput" type="text" placeholder="房间编号">
    <button onclick="joinRoom()">加入房间</button>
</div>
<div id="chat" style="display: none;">
    <h2>房间: <span id="roomIdDisplay"></span></h2>
    <h3>房主: <span id="ownerDisplay"></span></h3>
    <h4>用户列表:</h4>
    <ul id="userList"></ul>
    <textarea id="chatBox"></textarea>
    <button onclick="updateText()">同步文本</button>
</div>
<script type="importmap">
    {
      "imports": {
        "firebase/app": "https://www.gstatic.com/firebasejs/11.3.0/firebase-app.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/11.3.0/firebase-firestore.js"
      }
    }
</script>
<script type="module">
    import {initializeApp} from "firebase/app";
    import {getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot} from "firebase/firestore";

    const firebaseConfig = {
        apiKey: "AIzaSyCXQnBwpo7_lEFHxoSHfe4hDHwrktp9-rU",
        authDomain: "iat210.firebaseapp.com",
        projectId: "iat210",
        storageBucket: "iat210.firebasestorage.app",
        messagingSenderId: "282613477096",
        appId: "1:282613477096:web:bf80fdcb0679cd9f69635d",
        measurementId: "G-HV1P71XW4M"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let userName = localStorage.getItem("userName") || "";
    let roomId = localStorage.getItem("roomId") || "";

    document.getElementById("nameInput").value = userName;
    document.getElementById("roomInput").value = roomId;

    if (roomId) enterRoom(roomId);

    async function createRoom() {
        userName = document.getElementById('nameInput').value;
        if (!userName) return alert("请输入名字");
        roomId = Math.floor(100000 + Math.random() * 900000).toString();
        localStorage.setItem("userName", userName);
        localStorage.setItem("roomId", roomId);
        await setDoc(doc(db, "rooms", roomId), {text: "", owner: userName, users: [userName]});
        enterRoom(roomId);
    }

    async function joinRoom() {
        userName = document.getElementById('nameInput').value;
        roomId = document.getElementById('roomInput').value;
        if (!userName || !roomId) return alert("请输入名字和房间编号");
        const roomRef = doc(db, "rooms", roomId);
        const roomSnap = await getDoc(roomRef);
        if (!roomSnap.exists()) return alert("房间不存在");
        let data = roomSnap.data();
        if (!data.users.includes(userName)) {
            await updateDoc(roomRef, {users: [...data.users, userName]});
        }
        localStorage.setItem("userName", userName);
        localStorage.setItem("roomId", roomId);
        enterRoom(roomId);
    }

    function enterRoom(roomId) {
        document.getElementById('setup').style.display = 'none';
        document.getElementById('chat').style.display = 'block';
        document.getElementById('roomIdDisplay').innerText = roomId;
        onSnapshot(doc(db, "rooms", roomId), (docSnap) => {
            if (docSnap.exists()) {
                let data = docSnap.data();
                document.getElementById('chatBox').value = data.text;
                document.getElementById('ownerDisplay').innerText = data.owner;
                let userListElement = document.getElementById('userList');
                userListElement.innerHTML = "";
                data.users.forEach(user => {
                    let li = document.createElement("li");
                    li.textContent = user;
                    userListElement.appendChild(li);
                });
            }
        });
    }

    async function updateText() {
        let text = document.getElementById('chatBox').value;
        await updateDoc(doc(db, "rooms", roomId), {text: text});
    }

    window.createRoom = createRoom;
    window.joinRoom = joinRoom;
    window.updateText = updateText;

</script>
</body>
</html>
